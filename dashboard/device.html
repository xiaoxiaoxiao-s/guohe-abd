<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>iOS äº‘çœŸæœºæ§åˆ¶å°</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #202124;
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        justify-content: center;
        height: 100vh;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        gap: 20px;
        padding: 20px;
        box-sizing: border-box;
      }

      h2 {
        margin: 0 0 20px 0;
        text-align: center;
      }

      .left-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        max-width: 60%;
      }

      .right-panel {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 0 0 auto;
        min-width: 300px;
      }

      .phone-wrapper {
        position: relative;
        line-height: 0;
        width: 100%;
        display: flex;
        justify-content: center;
      }

      #screen-view {
        display: block;
        object-fit: contain;
        max-height: 90vh;
        max-width: 100%;
        cursor: pointer;
        user-select: none;
        -webkit-user-drag: none;
        border-radius: 18px;
      }

      /* æ–°å¢ï¼šè™šæ‹ŸæŒ‰é’®æ æ ·å¼ */
      .control-bar {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
      }

      .control-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
      }

      .control-section-title {
        font-size: 14px;
        color: #aaa;
        margin-bottom: 5px;
        text-align: center;
      }

      /* æ–¹å‘æ»‘åŠ¨æŒ‰é’®ç»„ */
      .swipe-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 5px;
        width: 180px;
        height: 180px;
        margin: 0 auto;
      }

      .swipe-btn {
        width: 100%;
        height: 100%;
        padding: 0;
        background: #444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 24px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .swipe-btn:hover {
        background: #666;
      }

      .swipe-btn:active {
        background: #888;
        transform: scale(0.9);
      }

      .swipe-btn-up {
        grid-column: 2;
        grid-row: 1;
      }

      .swipe-btn-down {
        grid-column: 2;
        grid-row: 3;
      }

      .swipe-btn-left {
        grid-column: 1;
        grid-row: 2;
      }

      .swipe-btn-right {
        grid-column: 3;
        grid-row: 2;
      }

      .btn {
        padding: 10px 20px;
        background: #444;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.2s;
        width: 100%;
      }

      .btn:hover {
        background: #666;
      }
      .btn:active {
        background: #888;
        transform: scale(0.95);
      }
      .btn-home {
        background: #2196f3;
      } /* è“è‰² Home é”® */

      .status-bar {
        margin-top: 15px;
        font-size: 14px;
        color: #aaa;
        text-align: center;
        width: 100%;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1024px) {
        body {
          flex-direction: column;
          padding: 10px;
        }

        .left-panel {
          max-width: 100%;
        }

        .right-panel {
          min-width: 100%;
          margin-top: 20px;
        }

        .control-bar {
          flex-direction: row;
          flex-wrap: wrap;
          justify-content: center;
        }

        .control-section {
          min-width: 200px;
        }
      }
    </style>
  </head>
  <body>
    <div class="left-panel">
      <h2>ğŸ“± iOS Remote Control</h2>
      <div class="phone-wrapper">
        <img id="screen-view" src="" alt="ç­‰å¾…è¿æ¥æ‰‹æœºç”»é¢..." />
      </div>
      <div class="status-bar">
        çŠ¶æ€: <span id="status-text">æ­£åœ¨è¿æ¥è§†é¢‘æµ...</span>
      </div>
      <div
        style="
          margin-top: 10px;
          font-size: 12px;
          color: #888;
          text-align: center;
          padding: 8px 12px;
          background: #2a2a2a;
          border-radius: 6px;
          border-left: 3px solid #4caf50;
        "
      >
        ğŸ’¡ æ“ä½œæç¤ºï¼šåŒå‡»å±å¹•è¡¨ç¤ºé•¿æŒ‰æ“ä½œ
      </div>
    </div>

    <div class="right-panel">
      <div class="control-bar">
        <div class="control-section">
          <div class="control-section-title">ç³»ç»Ÿæ“ä½œ</div>
          <button class="btn btn-home" onclick="goHome()">
            ğŸ  Home (å›æ¡Œé¢)
          </button>
        </div>

        <div class="control-section">
          <div class="control-section-title">æ–‡ä»¶ä¼ è¾“</div>
          <div style="display: flex; flex-direction: column; gap: 10px">
            <input
              type="file"
              id="videoFileInput"
              accept="video/*,image/*"
              style="display: none"
              onchange="handleFileSelect(event)"
            />
            <button
              class="btn"
              onclick="document.getElementById('videoFileInput').click()"
              style="width: 100%"
            >
              ğŸ“ é€‰æ‹©å›¾ç‰‡/è§†é¢‘
            </button>
            <div
              id="uploadStatus"
              style="
                font-size: 12px;
                color: #666;
                min-height: 20px;
                max-height: 60px;
                overflow-y: auto;
                word-wrap: break-word;
                word-break: break-all;
                line-height: 1.4;
                padding: 4px 0;
              "
            ></div>
          </div>
        </div>

        <div class="control-section">
          <div class="control-section-title">ç²˜è´´æ¿æ“ä½œ</div>
          <div style="display: flex; flex-direction: column; gap: 10px">
            <textarea
              id="clipboardInput"
              placeholder="è¾“å…¥è¦å¤åˆ¶åˆ°ç²˜è´´æ¿çš„å†…å®¹"
              rows="6"
              style="
                padding: 10px;
                background: #333;
                color: white;
                border: 1px solid #555;
                border-radius: 8px;
                font-size: 14px;
                width: 100%;
                box-sizing: border-box;
                resize: vertical;
                font-family: inherit;
              "
            ></textarea>
            <button class="btn" onclick="setClipboard()" style="width: 100%">
              ğŸ“‹ å¤åˆ¶åˆ°ç²˜è´´æ¿
            </button>
            <div
              style="
                font-size: 11px;
                color: #888;
                line-height: 1.4;
                padding: 6px 8px;
                background: #2a2a2a;
                border-radius: 6px;
                border-left: 3px solid #2196f3;
              "
            >
              ğŸ’¡ æç¤ºï¼šç²˜è´´å†…å®¹æ—¶ä¼šè‡ªåŠ¨å”¤èµ· WebDriverAgentRunner
              åº”ç”¨ï¼Œå®Œæˆåä¼šè‡ªåŠ¨è¿”å›ä¸»å±å¹•
            </div>
            <div
              id="clipboardStatus"
              style="font-size: 12px; color: #666; min-height: 20px"
            ></div>
          </div>
        </div>

        <div class="control-section">
          <div class="control-section-title">æ–¹å‘æ»‘åŠ¨</div>
          <div class="swipe-controls">
            <button
              class="swipe-btn swipe-btn-up"
              onclick="swipeDirection('up')"
              title="å‘ä¸Šæ»‘åŠ¨"
            >
              â†‘
            </button>
            <button
              class="swipe-btn swipe-btn-left"
              onclick="swipeDirection('left')"
              title="å‘å·¦æ»‘åŠ¨"
            >
              â†
            </button>
            <button
              class="swipe-btn swipe-btn-right"
              onclick="swipeDirection('right')"
              title="å‘å³æ»‘åŠ¨"
            >
              â†’
            </button>
            <button
              class="swipe-btn swipe-btn-down"
              onclick="swipeDirection('down')"
              title="å‘ä¸‹æ»‘åŠ¨"
            >
              â†“
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ä» URL å‚æ•°è·å–è®¾å¤‡ç«¯å£
      const urlParams = new URLSearchParams(window.location.search);
      const devicePort = urlParams.get("port");
      if (!devicePort) {
        alert("ç¼ºå°‘ç«¯å£å‚æ•°ï¼Œè¯·ä» Dashboard æ­£ç¡®è®¿é—®");
        window.location.href = "/";
      }

      // API åŸºç¡€ URLï¼ˆä½¿ç”¨è®¾å¤‡ç«¯å£ï¼‰
      const API_BASE = `${window.location.origin}/proxy/${devicePort}`;

      const screenImg = document.getElementById("screen-view");

      const statusText = document.getElementById("status-text");

      // è®¾ç½®è§†é¢‘æµ URL
      screenImg.src = `${API_BASE}/api/stream`;

      screenImg.onload = () => {
        statusText.innerText =
          "âœ… åœ¨çº¿ | å•å‡» / åŒå‡»é•¿æŒ‰ / å¿«é€Ÿæ»‘åŠ¨ / æ…¢é€Ÿæ‹–æ‹½";
        statusText.style.color = "#4caf50";
      };
      screenImg.onerror = () => {
        statusText.innerText = "âŒ è¿æ¥æ–­å¼€";
        statusText.style.color = "#f44336";
      };

      // ===============================================
      // æ™ºèƒ½äº¤äº’é€»è¾‘
      // ===============================================
      let startX = 0,
        startY = 0;
      let startTime = 0;
      let isDragging = false;
      let isDoubleClick = false; // æ ‡è®°æ˜¯å¦ä¸ºåŒå‡»
      let clickTimer = null; // å•å‡»å»¶è¿Ÿå®šæ—¶å™¨
      let isClipboardOperationInProgress = false; // æ ‡è®°ç²˜è´´æ“ä½œæ˜¯å¦æ­£åœ¨è¿›è¡Œ

      // 1. é¼ æ ‡æŒ‰ä¸‹
      screenImg.addEventListener("mousedown", (e) => {
        // å¦‚æœæ­£åœ¨æ‰§è¡Œç²˜è´´æ“ä½œï¼Œç¦æ­¢æ‰€æœ‰æŠ•å±æ“ä½œ
        if (isClipboardOperationInProgress) {
          e.preventDefault();
          return;
        }
        e.preventDefault();
        isDragging = true;
        const rect = screenImg.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        // è®°å½•æŒ‰ä¸‹æ—¶é—´
        startTime = new Date().getTime();
      });

      // 2. é¼ æ ‡æ¾å¼€ (æ™ºèƒ½åˆ¤æ–­æ„å›¾)
      screenImg.addEventListener("mouseup", async (e) => {
        // å¦‚æœæ­£åœ¨æ‰§è¡Œç²˜è´´æ“ä½œï¼Œç¦æ­¢æ‰€æœ‰æŠ•å±æ“ä½œ
        if (isClipboardOperationInProgress) {
          e.preventDefault();
          isDragging = false;
          return;
        }
        if (!isDragging) return;
        isDragging = false;

        const rect = screenImg.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;
        const viewWidth = rect.width;
        const viewHeight = rect.height;

        // è®¡ç®—è€—æ—¶
        const endTime = new Date().getTime();
        const timeDiff = endTime - startTime; // æ¯«ç§’

        // è®¡ç®—è·ç¦»
        const diffX = Math.abs(endX - startX);
        const diffY = Math.abs(endY - startY);
        const moveDistance = Math.sqrt(diffX * diffX + diffY * diffY);

        // --- é€»è¾‘åˆ†æ”¯ ---

        // 1. å¦‚æœç§»åŠ¨è·ç¦»å¾ˆå° -> ç‚¹å‡» (Tap) æˆ– é•¿æŒ‰æ£€æµ‹
        if (moveDistance < 10) {
          // æ£€æµ‹æ˜¯å¦ä¸ºé•¿æŒ‰ï¼ˆæŒ‰ä¸‹æ—¶é—´è¶…è¿‡1500msï¼Œé¿å…å’Œç‚¹å‡»æ··æ·†ï¼‰
          if (timeDiff >= 1500) {
            console.log("ğŸ“Œ è§¦å‘é•¿æŒ‰");
            statusText.innerText = "ğŸ“Œ æ‰§è¡Œé•¿æŒ‰æ“ä½œ...";
            setTimeout(() => (statusText.innerText = "âœ… åœ¨çº¿"), 2000);

            performAction("/api/longpress", {
              x: endX,
              y: endY,
              viewWidth,
              viewHeight,
            });
          } else {
            // å•å‡»å¤„ç†ï¼šå»¶è¿Ÿæ‰§è¡Œï¼Œå¦‚æœæ£€æµ‹åˆ°åŒå‡»åˆ™å–æ¶ˆ
            if (clickTimer) {
              clearTimeout(clickTimer);
            }
            clickTimer = setTimeout(() => {
              // æ£€æŸ¥æ˜¯å¦åˆšåˆšå‘ç”Ÿäº†åŒå‡»
              if (!isDoubleClick) {
                console.log("ğŸ‘† è§¦å‘ç‚¹å‡»");
                performAction("/api/tap", {
                  x: endX,
                  y: endY,
                  viewWidth,
                  viewHeight,
                });
              }
              clickTimer = null;
            }, 300); // 300mså»¶è¿Ÿï¼Œç­‰å¾…åŒå‡»äº‹ä»¶
          }
          return;
        }

        // 2. å¦‚æœç§»åŠ¨è·ç¦»å¤§ï¼Œæ ¹æ®è€—æ—¶åˆ¤æ–­æ˜¯ Swipe è¿˜æ˜¯ Drag
        if (timeDiff < 500) {
          // æ“ä½œå¿« (å°äº0.5ç§’) -> æ»‘åŠ¨/ç¿»é¡µ
          console.log("ğŸ’¨ è§¦å‘å¿«é€Ÿæ»‘åŠ¨ (Swipe)");
          performAction("/api/swipe", {
            startX,
            startY,
            endX,
            endY,
            viewWidth,
            viewHeight,
          });
        } else {
          // æ“ä½œæ…¢ (å¤§äº0.5ç§’) -> æ‹–æ‹½/ç§»åŠ¨å›¾æ ‡
          // å‰ç«¯æç¤ºç”¨æˆ·
          statusText.innerText = "âœŠ æ£€æµ‹åˆ°æ…¢é€Ÿæ“ä½œï¼Œæ­£åœ¨æ‰§è¡Œæ‹–æ‹½...";
          setTimeout(() => (statusText.innerText = "âœ… åœ¨çº¿"), 2000);

          console.log("âœŠ è§¦å‘æ…¢é€Ÿæ‹–æ‹½ (Drag)");
          performAction("/api/drag", {
            startX,
            startY,
            endX,
            endY,
            viewWidth,
            viewHeight,
          });
        }
      });

      screenImg.addEventListener("mouseleave", () => {
        isDragging = false;
      });

      // åŒå‡»äº‹ä»¶ï¼šè§¦å‘é•¿æŒ‰
      screenImg.addEventListener("dblclick", (e) => {
        // å¦‚æœæ­£åœ¨æ‰§è¡Œç²˜è´´æ“ä½œï¼Œç¦æ­¢æ‰€æœ‰æŠ•å±æ“ä½œ
        if (isClipboardOperationInProgress) {
          e.preventDefault();
          return;
        }
        e.preventDefault();
        isDoubleClick = true; // æ ‡è®°ä¸ºåŒå‡»ï¼Œé˜²æ­¢è§¦å‘å•å‡»

        // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„å•å‡»å®šæ—¶å™¨
        if (clickTimer) {
          clearTimeout(clickTimer);
          clickTimer = null;
        }

        const rect = screenImg.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const viewWidth = rect.width;
        const viewHeight = rect.height;

        console.log("ğŸ“Œ åŒå‡»è§¦å‘é•¿æŒ‰");
        statusText.innerText = "ğŸ“Œ æ‰§è¡Œé•¿æŒ‰æ“ä½œ...";
        setTimeout(() => (statusText.innerText = "âœ… åœ¨çº¿"), 2000);

        performAction("/api/longpress", {
          x: x,
          y: y,
          viewWidth,
          viewHeight,
        });

        // 300msåé‡ç½®åŒå‡»æ ‡è®°
        setTimeout(() => {
          isDoubleClick = false;
        }, 300);
      });

      // ä¼˜åŒ–ï¼šä½¿ç”¨ fire-and-forget æ¨¡å¼ï¼Œä¸ç­‰å¾…å“åº”
      function performAction(url, data) {
        // å¦‚æœ url æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä½¿ç”¨ API_BASE
        const fullUrl = url.startsWith("http") ? url : `${API_BASE}${url}`;
        fetch(fullUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        }).catch((err) => {
          console.error("æ“ä½œå¤±è´¥", err);
        });
        // ä¸ç­‰å¾…å“åº”ï¼Œç«‹å³è¿”å›
      }

      // æ–°å¢ï¼šHome é”®åŠŸèƒ½
      async function goHome() {
        console.log("ğŸ  æŒ‰ä¸‹ Home é”®");
        await performAction("/api/home", {});
      }

      // è·å–å±å¹•å°ºå¯¸ï¼ˆç”¨äºè®¡ç®—æ»‘åŠ¨åæ ‡ï¼‰
      let deviceSize = null;
      let deviceSizePromise = null;

      async function getDeviceSize() {
        if (deviceSize) return deviceSize;

        // å¦‚æœæ­£åœ¨è¯·æ±‚ï¼Œè¿”å›åŒä¸€ä¸ªPromise
        if (deviceSizePromise) {
          return deviceSizePromise;
        }

        deviceSizePromise = (async () => {
          try {
            const response = await fetch(`${API_BASE}/api/device/size`, {
              method: "GET",
            });
            if (response.ok) {
              const data = await response.json();
              deviceSize = { width: data.width, height: data.height };
              deviceSizePromise = null;
              return deviceSize;
            }
          } catch (e) {
            console.error("è·å–è®¾å¤‡å°ºå¯¸å¤±è´¥:", e);
          }
          // é»˜è®¤å°ºå¯¸
          deviceSize = { width: 375, height: 812 };
          deviceSizePromise = null;
          return deviceSize;
        })();

        return deviceSizePromise;
      }

      // é¡µé¢åŠ è½½æ—¶é¢„å…ˆè·å–è®¾å¤‡å°ºå¯¸
      getDeviceSize();

      // å››ä¸ªæ–¹å‘æ»‘åŠ¨ - ä¼˜åŒ–ç‰ˆæœ¬ï¼Œå‡å°‘å»¶è¿Ÿ
      function swipeDirection(direction) {
        const screenImg = document.getElementById("screen-view");
        const rect = screenImg.getBoundingClientRect();
        const viewWidth = rect.width;
        const viewHeight = rect.height;

        // ä½¿ç”¨ç¼“å­˜çš„å°ºå¯¸ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤å€¼ï¼ˆé¿å…ç­‰å¾…ï¼‰
        const defaultSize = { width: 375, height: 812 };
        const size = deviceSize || defaultSize;

        const centerX = size.width / 2;
        const centerY = size.height / 2;

        // å¢å¤§æ»‘åŠ¨è·ç¦»ï¼šå·¦å³æ»‘åŠ¨ä½¿ç”¨å±å¹•å®½åº¦çš„60%ï¼Œä¸Šä¸‹æ»‘åŠ¨ä½¿ç”¨å±å¹•é«˜åº¦çš„60%ï¼ˆåŠ å¿«æ»‘åŠ¨é€Ÿåº¦ï¼‰
        const horizontalSwipeDistance = size.width * 0.6; // å·¦å³æ»‘åŠ¨è·ç¦»ä¸ºå±å¹•å®½åº¦çš„60%
        const verticalSwipeDistance = size.height * 0.6; // ä¸Šä¸‹æ»‘åŠ¨è·ç¦»ä¸ºå±å¹•é«˜åº¦çš„60%ï¼ˆä»50%å¢åŠ åˆ°60%ï¼‰

        let startX, startY, endX, endY;

        switch (direction) {
          case "up":
            startX = centerX;
            startY = centerY + verticalSwipeDistance / 2;
            endX = centerX;
            endY = centerY - verticalSwipeDistance / 2;
            break;
          case "down":
            startX = centerX;
            startY = centerY - verticalSwipeDistance / 2;
            endX = centerX;
            endY = centerY + verticalSwipeDistance / 2;
            break;
          case "left":
            // ä»å·¦è¾¹ç¼˜å‘å³æ»‘åŠ¨ï¼Œå®ç°å‘å³åˆ‡æ¢ç•Œé¢
            startX = size.width * 0.1; // ä»å±å¹•å·¦ä¾§10%ä½ç½®å¼€å§‹
            startY = centerY;
            endX = size.width * 0.7; // æ»‘åŠ¨åˆ°å±å¹•70%ä½ç½®
            endY = centerY;
            break;
          case "right":
            // ä»å³è¾¹ç¼˜å‘å·¦æ»‘åŠ¨ï¼Œå®ç°å‘å·¦åˆ‡æ¢ç•Œé¢
            startX = size.width * 0.9; // ä»å±å¹•å³ä¾§90%ä½ç½®å¼€å§‹
            startY = centerY;
            endX = size.width * 0.3; // æ»‘åŠ¨åˆ°å±å¹•30%ä½ç½®
            endY = centerY;
            break;
        }

        // å°†è®¾å¤‡åæ ‡è½¬æ¢ä¸ºè§†å›¾åæ ‡
        const startXView = (startX / size.width) * viewWidth;
        const startYView = (startY / size.height) * viewHeight;
        const endXView = (endX / size.width) * viewWidth;
        const endYView = (endY / size.height) * viewHeight;

        // ç«‹å³æ‰§è¡Œï¼Œä¸ç­‰å¾…
        performAction("/api/swipe", {
          startX: startXView,
          startY: startYView,
          endX: endXView,
          endY: endYView,
          viewWidth,
          viewHeight,
        });

        // å¦‚æœå°ºå¯¸è¿˜æ²¡åŠ è½½ï¼Œå¼‚æ­¥æ›´æ–°ï¼ˆä¸å½±å“å½“å‰æ“ä½œï¼‰
        if (!deviceSize) {
          getDeviceSize().then((actualSize) => {
            // å°ºå¯¸åŠ è½½å®Œæˆåï¼Œä¸‹æ¬¡æ“ä½œä¼šä½¿ç”¨å®é™…å°ºå¯¸
          });
        }
      }

      // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
      function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (
          !file.type.startsWith("video/") &&
          !file.type.startsWith("image/")
        ) {
          showUploadStatus("âŒ è¯·é€‰æ‹©å›¾ç‰‡æˆ–è§†é¢‘æ–‡ä»¶", "error");
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆ2GBï¼‰
        const maxSize = 2 * 1024 * 1024 * 1024;
        if (file.size > maxSize) {
          showUploadStatus("âŒ æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 2GB", "error");
          return;
        }

        uploadFile(file);
      }

      async function uploadFile(file) {
        const statusDiv = document.getElementById("uploadStatus");
        const formData = new FormData();
        formData.append("video", file);

        showUploadStatus(
          `ğŸ“¤ æ­£åœ¨ä¸Šä¼ : ${file.name} (${formatFileSize(file.size)})...`,
          "uploading"
        );

        try {
          const response = await fetch(`${API_BASE}/api/upload`, {
            method: "POST",
            body: formData,
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showUploadStatus(`âœ… ${result.message}`, "success");
          } else {
            showUploadStatus(
              `âŒ ${result.error || result.message || "ä¸Šä¼ å¤±è´¥"}`,
              "error"
            );
            if (result.details) {
              console.error("ä¸Šä¼ é”™è¯¯è¯¦æƒ…:", result.details);
            }
          }
        } catch (error) {
          console.error("ä¸Šä¼ å¤±è´¥:", error);
          showUploadStatus(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, "error");
        } finally {
          // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©ï¼Œå…è®¸é‡å¤é€‰æ‹©åŒä¸€æ–‡ä»¶
          document.getElementById("videoFileInput").value = "";
        }
      }

      function showUploadStatus(message, type) {
        const statusDiv = document.getElementById("uploadStatus");
        // é™åˆ¶æ¶ˆæ¯é•¿åº¦ï¼Œé¿å…è¿‡é•¿æ–‡æœ¬æ’‘å¼€å¸ƒå±€
        const maxLength = 100;
        const displayMessage =
          message.length > maxLength
            ? message.substring(0, maxLength) + "..."
            : message;
        statusDiv.textContent = displayMessage;
        // å¦‚æœæ¶ˆæ¯è¢«æˆªæ–­ï¼Œæ·»åŠ  title å±æ€§æ˜¾ç¤ºå®Œæ•´æ¶ˆæ¯
        if (message.length > maxLength) {
          statusDiv.title = message;
        } else {
          statusDiv.title = "";
        }
        statusDiv.style.color =
          type === "success"
            ? "#4caf50"
            : type === "error"
            ? "#f44336"
            : type === "uploading"
            ? "#2196f3"
            : "#666";

        // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯ï¼Œ5ç§’åæ¸…é™¤é”™è¯¯æ¶ˆæ¯
        if (type === "success") {
          setTimeout(() => {
            if (statusDiv.textContent === displayMessage) {
              statusDiv.textContent = "";
              statusDiv.title = "";
            }
          }, 3000);
        } else if (type === "error") {
          setTimeout(() => {
            if (statusDiv.textContent === displayMessage) {
              statusDiv.textContent = "";
              statusDiv.title = "";
            }
          }, 5000);
        }
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i]
        );
      }

      // ç²˜è´´æ¿åŠŸèƒ½ - ç›´æ¥é€šè¿‡ WDA è®¾ç½®åˆ°æ‰‹æœºç²˜è´´æ¿
      async function setClipboard() {
        const input = document.getElementById("clipboardInput");
        const text = input.value.trim();
        const statusDiv = document.getElementById("clipboardStatus");

        if (!text) {
          showClipboardStatus("âŒ è¯·è¾“å…¥è¦å¤åˆ¶çš„å†…å®¹", "error");
          return;
        }

        // å¦‚æœå·²ç»åœ¨æ‰§è¡Œç²˜è´´æ“ä½œï¼Œç¦æ­¢é‡å¤æ“ä½œ
        if (isClipboardOperationInProgress) {
          showClipboardStatus("âš ï¸ ç²˜è´´æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™...", "error");
          return;
        }

        // è®¾ç½®æ ‡å¿—ï¼Œç¦æ­¢æ‰€æœ‰æŠ•å±æ“ä½œ
        isClipboardOperationInProgress = true;
        showClipboardStatus("ğŸ“‹ æ­£åœ¨é€šè¿‡ WDA è®¾ç½®åˆ°æ‰‹æœºç²˜è´´æ¿...", "uploading");
        // æ›´æ–°çŠ¶æ€æ æç¤º
        const originalStatus = statusText.innerText;
        statusText.innerText = "â³ ç²˜è´´æ“ä½œä¸­ï¼ŒæŠ•å±æ“ä½œå·²ç¦ç”¨...";

        try {
          // ç›´æ¥è°ƒç”¨åç«¯æ¥å£ï¼Œé€šè¿‡ WDA å°†æ–‡æœ¬è®¾ç½®åˆ°æ‰‹æœºç²˜è´´æ¿
          const response = await fetch(`${API_BASE}/api/clipboard`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: text }),
          });

          const result = await response.json();

          if (response.ok && result.success) {
            showClipboardStatus("âœ… å·²æˆåŠŸè®¾ç½®åˆ°æ‰‹æœºç²˜è´´æ¿", "success");
          } else {
            showClipboardStatus(
              `âŒ ${result.error || result.details || "è®¾ç½®å¤±è´¥"}`,
              "error"
            );
          }
        } catch (error) {
          console.error("è®¾ç½®ç²˜è´´æ¿å¤±è´¥:", error);
          showClipboardStatus(`âŒ è®¾ç½®å¤±è´¥: ${error.message}`, "error");
        } finally {
          // æ— è®ºæˆåŠŸæˆ–å¤±è´¥ï¼Œéƒ½è¦æ¢å¤æŠ•å±æ“ä½œ
          isClipboardOperationInProgress = false;
          statusText.innerText = originalStatus || "âœ… åœ¨çº¿";
        }
      }

      function showClipboardStatus(message, type) {
        const statusDiv = document.getElementById("clipboardStatus");
        statusDiv.textContent = message;
        statusDiv.style.color =
          type === "success"
            ? "#4caf50"
            : type === "error"
            ? "#f44336"
            : type === "uploading"
            ? "#2196f3"
            : "#666";

        // 3ç§’åæ¸…é™¤æˆåŠŸæ¶ˆæ¯
        if (type === "success") {
          setTimeout(() => {
            if (statusDiv.textContent === message) {
              statusDiv.textContent = "";
            }
          }, 3000);
        }
      }
    </script>
  </body>
</html>
